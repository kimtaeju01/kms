// Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0
// @ts-ignore
import { Transform as PortableTransform } from 'readable-stream';
import { NodeAlgorithmSuite, getDecryptionHelper, } from '@aws-crypto/material-management-node';
import { deserializeFactory, kdfInfo } from '@aws-crypto/serialize';
const toUtf8 = (input) => Buffer.from(input.buffer, input.byteOffset, input.byteLength).toString('utf8');
const deserialize = deserializeFactory(toUtf8, NodeAlgorithmSuite);
const PortableTransformWithType = PortableTransform;
export class ParseHeaderStream extends PortableTransformWithType {
    constructor(cmm) {
        super();
        Object.defineProperty(this, 'materialsManager', {
            value: cmm,
            enumerable: true,
        });
        this._headerState = {
            buffer: Buffer.alloc(0),
            headerParsed: false,
        };
    }
    _transform(chunk, encoding, callback) {
        const { buffer } = this._headerState;
        const headerBuffer = Buffer.concat([buffer, chunk]);
        const headerInfo = deserialize.deserializeMessageHeader(headerBuffer);
        if (!headerInfo) {
            this._headerState.buffer = headerBuffer;
            return callback();
        }
        const { messageHeader, algorithmSuite } = headerInfo;
        const { rawHeader, headerIv, headerAuthTag } = headerInfo;
        const suite = new NodeAlgorithmSuite(algorithmSuite.id);
        const { encryptionContext, encryptedDataKeys } = messageHeader;
        this.materialsManager
            .decryptMaterials({ suite, encryptionContext, encryptedDataKeys })
            .then((material) => {
            this._headerState.buffer = Buffer.alloc(0); // clear the Buffer...
            const { kdfGetDecipher, getVerify, dispose } = getDecryptionHelper(material);
            const info = kdfInfo(messageHeader.suiteId, messageHeader.messageId);
            const getDecipher = kdfGetDecipher(info);
            const headerAuth = getDecipher(headerIv);
            headerAuth.setAAD(Buffer.from(rawHeader.buffer, rawHeader.byteOffset, rawHeader.byteLength));
            headerAuth.setAuthTag(Buffer.from(headerAuthTag.buffer, headerAuthTag.byteOffset, headerAuthTag.byteLength));
            headerAuth.update(Buffer.alloc(0));
            headerAuth.final(); // will throw if invalid
            const verify = getVerify ? getVerify() : void 0;
            const verifyInfo = {
                headerInfo,
                getDecipher,
                verify,
                dispose,
            };
            this.emit('VerifyInfo', verifyInfo);
            this.emit('MessageHeader', headerInfo.messageHeader);
            this._headerState.headerParsed = true;
            // The header is parsed, pass control
            const readPos = rawHeader.byteLength + headerIv.byteLength + headerAuthTag.byteLength;
            const tail = headerBuffer.slice(readPos);
            /* needs calls in downstream _transform streams will throw.
             * But streams are async.
             * So this error should be turned into an `.emit('error', ex)`.
             */
            this._transform = (chunk, _enc, cb) => {
                try {
                    cb(null, chunk);
                }
                catch (ex) {
                    this.emit('error', ex);
                }
            };
            // flush the tail.  Stream control is now in the verify and decrypt streams
            return setImmediate(() => this._transform(tail, encoding, callback));
        })
            .catch((err) => callback(err));
    }
    _flush(callback) {
        /* Postcondition: A completed header MUST have been processed.
         * callback is an errBack function,
         * so it expects either an error OR undefined
         */
        callback(this._headerState.headerParsed
            ? undefined
            : new Error('Incomplete Header'));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2VfaGVhZGVyX3N0cmVhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wYXJzZV9oZWFkZXJfc3RyZWFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLG9FQUFvRTtBQUNwRSxzQ0FBc0M7QUFFdEMsYUFBYTtBQUNiLE9BQU8sRUFBRSxTQUFTLElBQUksaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQTtBQUVoRSxPQUFPLEVBQ0wsa0JBQWtCLEVBRWxCLG1CQUFtQixHQUNwQixNQUFNLHNDQUFzQyxDQUFBO0FBQzdDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxPQUFPLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQTtBQUduRSxNQUFNLE1BQU0sR0FBRyxDQUFDLEtBQWlCLEVBQUUsRUFBRSxDQUNuQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0FBQ2hGLE1BQU0sV0FBVyxHQUFHLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxrQkFBa0IsQ0FBQyxDQUFBO0FBQ2xFLE1BQU0seUJBQXlCLEdBQUcsaUJBRXBCLENBQUE7QUFPZCxNQUFNLE9BQU8saUJBQWtCLFNBQVEseUJBQXlCO0lBRzlELFlBQVksR0FBeUI7UUFDbkMsS0FBSyxFQUFFLENBQUE7UUFDUCxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRTtZQUM5QyxLQUFLLEVBQUUsR0FBRztZQUNWLFVBQVUsRUFBRSxJQUFJO1NBQ2pCLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxZQUFZLEdBQUc7WUFDbEIsTUFBTSxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLFlBQVksRUFBRSxLQUFLO1NBQ3BCLENBQUE7SUFDSCxDQUFDO0lBRUQsVUFBVSxDQUFDLEtBQVUsRUFBRSxRQUFnQixFQUFFLFFBQWtCO1FBQ3pELE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFBO1FBQ3BDLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUNuRCxNQUFNLFVBQVUsR0FBRyxXQUFXLENBQUMsd0JBQXdCLENBQUMsWUFBWSxDQUFDLENBQUE7UUFDckUsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNmLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxHQUFHLFlBQVksQ0FBQTtZQUN2QyxPQUFPLFFBQVEsRUFBRSxDQUFBO1NBQ2xCO1FBRUQsTUFBTSxFQUFFLGFBQWEsRUFBRSxjQUFjLEVBQUUsR0FBRyxVQUFVLENBQUE7UUFDcEQsTUFBTSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLEdBQUcsVUFBVSxDQUFBO1FBRXpELE1BQU0sS0FBSyxHQUFHLElBQUksa0JBQWtCLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQ3ZELE1BQU0sRUFBRSxpQkFBaUIsRUFBRSxpQkFBaUIsRUFBRSxHQUFHLGFBQWEsQ0FBQTtRQUU5RCxJQUFJLENBQUMsZ0JBQWdCO2FBQ2xCLGdCQUFnQixDQUFDLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFLGlCQUFpQixFQUFFLENBQUM7YUFDakUsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDakIsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFDLHNCQUFzQjtZQUVqRSxNQUFNLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsR0FBRyxtQkFBbUIsQ0FDaEUsUUFBUSxDQUNULENBQUE7WUFFRCxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUE7WUFDcEUsTUFBTSxXQUFXLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ3hDLE1BQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQTtZQUV4QyxVQUFVLENBQUMsTUFBTSxDQUNmLE1BQU0sQ0FBQyxJQUFJLENBQ1QsU0FBUyxDQUFDLE1BQU0sRUFDaEIsU0FBUyxDQUFDLFVBQVUsRUFDcEIsU0FBUyxDQUFDLFVBQVUsQ0FDckIsQ0FDRixDQUFBO1lBQ0QsVUFBVSxDQUFDLFVBQVUsQ0FDbkIsTUFBTSxDQUFDLElBQUksQ0FDVCxhQUFhLENBQUMsTUFBTSxFQUNwQixhQUFhLENBQUMsVUFBVSxFQUN4QixhQUFhLENBQUMsVUFBVSxDQUN6QixDQUNGLENBQUE7WUFDRCxVQUFVLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNsQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUEsQ0FBQyx3QkFBd0I7WUFFM0MsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDL0MsTUFBTSxVQUFVLEdBQWU7Z0JBQzdCLFVBQVU7Z0JBQ1YsV0FBVztnQkFDWCxNQUFNO2dCQUNOLE9BQU87YUFDUixDQUFBO1lBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUE7WUFDbkMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFBO1lBRXBELElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQTtZQUVyQyxxQ0FBcUM7WUFDckMsTUFBTSxPQUFPLEdBQ1gsU0FBUyxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUMsVUFBVSxHQUFHLGFBQWEsQ0FBQyxVQUFVLENBQUE7WUFDdkUsTUFBTSxJQUFJLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUN4Qzs7O2VBR0c7WUFDSCxJQUFJLENBQUMsVUFBVSxHQUFHLENBQUMsS0FBVSxFQUFFLElBQVksRUFBRSxFQUFZLEVBQUUsRUFBRTtnQkFDM0QsSUFBSTtvQkFDRixFQUFFLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFBO2lCQUNoQjtnQkFBQyxPQUFPLEVBQUUsRUFBRTtvQkFDWCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQTtpQkFDdkI7WUFDSCxDQUFDLENBQUE7WUFDRCwyRUFBMkU7WUFDM0UsT0FBTyxZQUFZLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUE7UUFDdEUsQ0FBQyxDQUFDO2FBQ0QsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUNsQyxDQUFDO0lBRUQsTUFBTSxDQUFDLFFBQWtCO1FBQ3ZCOzs7V0FHRztRQUNILFFBQVEsQ0FDTixJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVk7WUFDNUIsQ0FBQyxDQUFDLFNBQVM7WUFDWCxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FDbkMsQ0FBQTtJQUNILENBQUM7Q0FDRiJ9